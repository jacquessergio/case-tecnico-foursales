
---

## üìã Descri√ß√£o do Projeto

Este projeto √© uma **plataforma de e-commerce** desenvolvida com arquitetura de microsservi√ßos, projetada para demonstrar a implementa√ß√£o de padr√µes enterprise-grade em sistemas distribu√≠dos. O sistema oferece funcionalidades essenciais de com√©rcio eletr√¥nico, incluindo gerenciamento de produtos, processamento de pedidos, controle de estoque e autentica√ß√£o de usu√°rios, com foco especial em **confiabilidade**, **escalabilidade** e **seguran√ßa**.

### Principais Caracter√≠sticas

- **Arquitetura Event-Driven**: Comunica√ß√£o ass√≠ncrona via Apache Kafka garantindo desacoplamento entre servi√ßos
- **Consist√™ncia Eventual**: Implementa√ß√£o do padr√£o Transactional Outbox para garantia de entrega de eventos
- **Alta Disponibilidade**: Circuit Breakers e fallback strategies para resili√™ncia a falhas de depend√™ncias
- **Seguran√ßa Robusta**: Autentica√ß√£o JWT, RBAC, rate limiting, account lockout e valida√ß√£o de complexidade de senha
- **Performance Otimizada**: Pessimistic locking para opera√ß√µes cr√≠ticas, √≠ndices estrat√©gicos e pool de conex√µes HikariCP
- **Busca Avan√ßada**: Integra√ß√£o com Elasticsearch para full-text search com fuzzy matching
- **Observabilidade**: Logs estruturados, m√©tricas de circuit breakers, endpoints de administra√ß√£o e Swagger UI


## üìù Requisitos do Sistema

### Requisitos Funcionais

| ID | Requisito | Descri√ß√£o | Prioridade |
|----|-----------|-----------|------------|
| **RF-001** | Cadastro de Usu√°rios | Sistema deve permitir cadastro de usu√°rios com valida√ß√£o de email √∫nico e senha forte (8+ chars, mai√∫sculas, min√∫sculas, n√∫meros, caracteres especiais) | Alta |
| **RF-002** | Autentica√ß√£o JWT | Sistema deve autenticar usu√°rios via email/senha e retornar token JWT com validade de 24h | Alta |
| **RF-003** | Gerenciamento de Produtos (Admin) | Administradores devem criar, atualizar, visualizar e remover produtos | Alta |
| **RF-004** | Usuario final (User) | Usuarios devem  criar pedidos, pagar pedidos e visualizar produtos | Alta |
| **RF-005** | Busca de Produtos | Usu√°rios devem buscar produtos por nome com suporte a fuzzy matching e filtros por categoria | Alta |
| **RF-006** | Cria√ß√£o de Pedidos | Usu√°rios autenticados devem criar pedidos com um ou mais produtos, validando estoque dispon√≠vel em tempo real | Alta |
| **RF-007** | Confirma√ß√£o de Pagamento | Sistema deve permitir confirma√ß√£o de pagamento de pedidos com status PENDENTE, alterando para PAGO | Alta |
| **RF-008** | Redu√ß√£o de Estoque Ass√≠ncrona | Sistema deve reduzir estoque APENAS ap√≥s confirma√ß√£o de pagamento via eventos Kafka | Alta |
| **RF-009** | Sincroniza√ß√£o MySQL ‚Üî Elasticsearch | Altera√ß√µes em produtos no MySQL devem ser sincronizadas automaticamente com Elasticsearch via eventos | Alta |
| **RF-010** | Consulta de Pedidos | Usu√°rios devem consultar apenas seus pr√≥prios pedidos; administradores podem consultar todos | Alta |
| **RF-011** | Preven√ß√£o de Pedidos Duplicados | Sistema deve implementar idempotency keys para prevenir cria√ß√£o de pedidos duplicados (double-click, retry) | M√©dia |
| **RF-012** | Relat√≥rios Administrativos | Administradores devem visualizar: top 5 usu√°rios que mais compraram, ticket m√©dio¬†dos pedidos por usu√°rio e valor total faturado no m√™s atual | M√©dia |


### Requisitos N√£o Funcionais

| ID | Categoria | Requisito | Especifica√ß√£o | Implementa√ß√£o |
|----|-----------|-----------|---------------|---------------|
| **RNF-001** | **Disponibilidade** | Alta disponibilidade de leitura | Sistema deve manter disponibilidade de busca mesmo com Elasticsearch offline | Circuit Breaker + Fallback MySQL |
| **RNF-002** | **Disponibilidade** | Toler√¢ncia a falhas de mensageria | Sistema deve garantir entrega de eventos cr√≠ticos mesmo com Kafka temporariamente indispon√≠vel | Transactional Outbox Pattern |
| **RNF-003** | **Consist√™ncia** | Consist√™ncia eventual | Sistema deve garantir consist√™ncia eventual entre MySQL e Elasticsearch em at√© 10 segundos | Event Sourcing + Idempotency |
| **RNF-004** | **Consist√™ncia** | Atomicidade de pagamentos | Altera√ß√£o de status de pedido e publica√ß√£o de evento devem ser at√¥micas | Transactional Outbox (ACID) |
| **RNF-005** | **Performance** | Tempo de resposta de APIs | 95% das requisi√ß√µes devem responder em < 500ms (P95) | Pessimistic Locking, HikariCP tuning, Database indexes |
| **RNF-006** | **Performance** | Busca de produtos | Busca por nome deve retornar resultados em < 200ms para cat√°logos de at√© 100k produtos | Elasticsearch com fuzzy matching |
| **RNF-007** | **Performance** | Throughput de pedidos | Sistema deve processar at√© 100 pedidos/segundo | Connection pooling, async processing |
| **RNF-008** | **Seguran√ßa** | Prote√ß√£o contra brute force | Login deve bloquear conta ap√≥s 5 tentativas falhas por 30 minutos | Account Lockout (Caffeine cache) |
| **RNF-009** | **Seguran√ßa** | Prote√ß√£o contra DDoS | Endpoints p√∫blicos devem limitar requisi√ß√µes a 100/min por IP | Rate Limiting (Token Bucket) |
| **RNF-010** | **Seguran√ßa** | Autentica√ß√£o stateless | Sistema deve usar autentica√ß√£o stateless com tokens JWT (HS512) | JWT com 512-bit secret, expiration 24h |
| **RNF-011** | **Seguran√ßa** | Controle de acesso baseado em roles | Sistema deve implementar RBAC com roles USER e ADMIN | Spring Security + @PreAuthorize |
| **RNF-012** | **Seguran√ßa** | Prote√ß√£o de senhas | Senhas devem ser armazenadas com hash BCrypt (cost factor 10) | BCryptPasswordEncoder |
| **RNF-013** | **Escalabilidade** | Horizontal scaling | Sistema deve suportar m√∫ltiplas inst√¢ncias sem conflitos | Stateless services, Kafka consumer groups |
| **RNF-014** | **Escalabilidade** | Desacoplamento de servi√ßos | Microsservi√ßos devem comunicar-se de forma ass√≠ncrona | Event-Driven Architecture (Kafka) |
| **RNF-015** | **Resili√™ncia** | Circuit Breaker para depend√™ncias | Sistema deve abrir circuito ap√≥s 50% de falhas em Elasticsearch (sliding window de 10 requisi√ß√µes) | Resilience4j Circuit Breaker |
| **RNF-016** | **Resili√™ncia** | Reprocessamento autom√°tico | Eventos falhos devem ser reprocessados automaticamente com backoff: 1m ‚Üí 2m ‚Üí 4m ‚Üí 8m ‚Üí 16m ‚Üí 32m ‚Üí 60m | DLQ + Scheduled Reprocessor |
| **RNF-017** | **Resili√™ncia** | Race condition prevention | Opera√ß√µes de estoque devem prevenir condi√ß√µes de corrida (TOCTOU) | Pessimistic Locking (@Lock) |
| **RNF-018** | **Manutenibilidade** | Versionamento de schema | Altera√ß√µes de banco de dados devem ser versionadas e auditadas | Flyway Migrations |
| **RNF-019** | **Manutenibilidade** | Logs estruturados | Sistema deve gerar logs estruturados com n√≠veis apropriados (INFO, WARN, ERROR) | SLF4J + Logback |
| **RNF-020** | **Observabilidade** | Documenta√ß√£o de API | Sistema deve expor documenta√ß√£o interativa de APIs | Swagger UI (Springdoc OpenAPI) |
| **RNF-021** | **Observabilidade** | Monitoramento de Circuit Breakers | Administradores devem visualizar estado de circuit breakers em tempo real | Admin endpoints + metrics |
| **RNF-022** | **Observabilidade** | Rastreamento de eventos | Sistema deve rastrear eventos processados e falhos com timestamps | ProcessedEvent e FailedEvent entities |
| **RNF-023** | **Testabilidade** | Isolamento de depend√™ncias | Controllers devem depender de interfaces para facilitar mocks | Dependency Inversion (SOLID) |
| **RNF-024** | **Portabilidade** | Containeriza√ß√£o | Infraestrutura deve ser provisionada via Docker Compose | MySQL, Elasticsearch, Kafka containers |

### Constraints (Restri√ß√µes)

- **C-001**: Sistema deve usar Java 17 LTS
- **C-002**: Persist√™ncia prim√°ria deve ser MySQL 8.0 (ACID compliance)
- **C-003**: Eventos cr√≠ticos (pagamento) devem ter garantia de entrega (At-Least-Once)
- **C-004**: Token JWT deve expirar em no m√°ximo 24 horas
- **C-005**: Migra√ß√µes de banco de dados devem ser imut√°veis (checksum validation)
- **C-006**: Senhas devem ter no m√≠nimo 8 caracteres
- **C-007**: Estoque nunca pode ficar negativo (constraint de neg√≥cio)

---

## üèóÔ∏è Arquitetura do Sistema

### Vis√£o Geral

Sistema distribu√≠do com **tr√™s microsservi√ßos** comunicando-se via Kafka, garantindo alta disponibilidade e toler√¢ncia a falhas.

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Main API (Port 8080) - Public & User Operations                   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îÇ
‚îÇ  ‚îÇ Rate Limit   ‚îÇ‚Üí ‚îÇ JWT Auth     ‚îÇ‚Üí ‚îÇ Circuit      ‚îÇ              ‚îÇ
‚îÇ  ‚îÇ Filter       ‚îÇ  ‚îÇ Filter       ‚îÇ  ‚îÇ Breaker      ‚îÇ              ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îÇ
‚îÇ         ‚Üì                  ‚Üì                  ‚Üì                      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  Business Logic (Service Layer)                               ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ OrderService - Pedidos com valida√ß√£o de estoque           ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ ProductService - Cat√°logo com dual-write prevention       ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ AuthService - JWT + Account Lockout                       ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ         ‚Üì                              ‚Üì                            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îÇ
‚îÇ  ‚îÇ MySQL       ‚îÇ  ‚îÇ Elasticsearch ‚îÇ  ‚îÇ Outbox Table ‚îÇ              ‚îÇ
‚îÇ  ‚îÇ (ACID)      ‚îÇ  ‚îÇ (Search)      ‚îÇ  ‚îÇ (Events)     ‚îÇ              ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îÇ
‚îÇ                                             ‚Üì                       ‚îÇ
‚îÇ                              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
‚îÇ                              ‚îÇ Kafka Producer          ‚îÇ            ‚îÇ
‚îÇ                              ‚îÇ (Transactional Outbox)  ‚îÇ            ‚îÇ
‚îÇ                              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                       ‚îÇ
                          Kafka Topics: order.paid
                                       product.sync
                                       ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Consumer (Port 8081) - Async Stock & Sync                         ‚îÇ
‚îÇ  ‚Ä¢ OrderEventConsumer - Stock reduction after payment               ‚îÇ
‚îÇ  ‚Ä¢ ProductSyncConsumer - MySQL ‚Üî Elasticsearch consistency         ‚îÇ
‚îÇ  ‚Ä¢ DLQ Reprocessor - Automatic retry with exponential backoff      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Stack Tecnol√≥gico

| Camada | Tecnologia | Vers√£o | Prop√≥sito |
|--------|------------|--------|-----------|
| **Runtime** | Java | 17 | LTS com performance otimizada |
| **Framework** | Spring Boot | 3.2.0 | Foundation para microservices |
| **Persist√™ncia** | MySQL | 8.0 | ACID transactions |
| **Schema Versioning** | Flyway | 9.x | Database migrations |
| **Search Engine** | Elasticsearch | 8.11.0 | Full-text search, fuzzy matching |
| **Mensageria** | Apache Kafka | 2.8+ | Event streaming |
| **Seguran√ßa** | Spring Security + JWT | JJWT 0.11.5 | Autentica√ß√£o stateless |
| **Resili√™ncia** | Resilience4j | 2.1.0 | Circuit breaker, fallbacks |
| **Rate Limiting** | Bucket4j | 8.7.0 | Token bucket algorithm |
| **Cache** | Caffeine | Latest | In-memory caching |
| **Documenta√ß√£o** | Springdoc OpenAPI | 2.2.0 | Swagger UI |

---

## üöÄ Quick Start

### Pr√©-requisitos
- Java 17+ (OpenJDK ou Oracle)
- Maven 3.6+
- Docker & Docker Compose

### 1. Iniciar Infraestrutura
```bash
cd case-ecommerce-microservice
docker-compose up -d

# Verificar sa√∫de dos servi√ßos
docker-compose ps
```

**Servi√ßos iniciados:**
- MySQL (3306) - ACID transactions
- Elasticsearch (9200) - Full-text search
- Kafka (9092) - Event streaming
- Zookeeper (2181) - Kafka coordination
- Kafka UI (8090) - Kafka management

### 2. Build & Run
```bash
# Build
mvn clean package

# Run (porta 8080)
mvn spring-boot:run
```

**Endpoints:**
- API: http://localhost:8080
- Swagger UI: http://localhost:8080/swagger-ui.html
- OpenAPI Spec: http://localhost:8080/v3/api-docs

### 3. Iniciar Consumer
```bash
cd ../case-ecommerce-consumer
mvn clean package
mvn spring-boot:run  # Porta 8081
```

---

## üß™ Considera√ß√µes e Instru√ß√µes de Teste

### Endpoints Dispon√≠veis na API

**Autentica√ß√£o** (`/api/v1/auth`):
- `POST /login` - Login
- `POST /register` - Registro de usu√°rio

**Produtos** (`/api/v1/products`):
- `GET /` - Listar produtos (com pagina√ß√£o: page, size, sort)
- `GET /{id}` - Buscar produto por ID
- `GET /search` - Buscar com filtros (name, category, priceMin, priceMax)
- `POST /` - Criar produto (ADMIN)
- `PUT /{id}` - Atualizar produto (ADMIN)
- `DELETE /{id}` - Deletar produto (ADMIN)

**Pedidos** (`/api/v1/orders`):
- `GET /` - Listar pedidos do usu√°rio
- `GET /{id}` - Buscar pedido por ID
- `POST /` - Criar pedido
- `POST /{id}/pay` - Confirmar pagamento

**Relat√≥rios** (`/api/v1/reports` - ADMIN apenas):
- `GET /top-users` - Top 5 usu√°rios compradores (com filtro de datas: startDate, endDate)
- `GET /average-ticket` - Ticket m√©dio por usu√°rio (com filtro de datas)
- `GET /current-month-revenue` - Receita do m√™s atual

---

### üìö Documenta√ß√£o de Testes

Este projeto possui endpoints espec√≠ficos implementados. Para exemplos detalhados de requisi√ß√µes curl com todos os endpoints dispon√≠veis, consulte o arquivo [TESTING_EXAMPLES.md](./docs/TESTING_EXAMPLES.md).

- [QA_TEST_REPORT.md](./docs/QA_TEST_REPORT.md) - Relat√≥rio completo de testes executados
- [ADVANCED_TESTS_REPORT.md](./docs/ADVANCED_TESTS_REPORT.md) - Testes avan√ßados (resili√™ncia, seguran√ßa)

---

## üîí Seguran√ßa em Profundidade

### ‚ö†Ô∏è AVISO: Configura√ß√£o de Produ√ß√£o

**IMPORTANTE**: Este √© um projeto educacional. Para **produ√ß√£o**, externalize credenciais:

```yaml
# application-prod.yml
app:
  jwt:
    secret: ${JWT_SECRET}  # Vari√°vel de ambiente

spring:
  datasource:
    url: ${DB_URL}
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}

elasticsearch:
  uris: ${ELASTICSEARCH_URL}
  username: ${ELASTICSEARCH_USERNAME}
  password: ${ELASTICSEARCH_PASSWORD}
```

Consulte [SECURITY_AUDIT_REPORT.md](../SECURITY_AUDIT_REPORT.md) para detalhes completos.

---

### Camadas de Seguran√ßa

#### 1. Rate Limiting (Primeira Linha de Defesa)

**Algoritmo:** Token Bucket (Bucket4j)
**Posi√ß√£o:** ANTES do JwtAuthenticationFilter

| Tipo | Limite | Janela | Prote√ß√£o |
|------|--------|--------|----------|
| `AUTH` | 5 req/min | Brute force em login |
| `PUBLIC` | 100 req/min | DDoS, scraping |
| `USER` | 30 req/min | Abuso de recursos autenticados |
| `ADMIN` | 60 req/min | Insider threat |
| `SEARCH` | 60 req/min | Elasticsearch query abuse |
| `REPORT` | 10 req/min | DB overload (agrega√ß√µes pesadas) |

**Key Strategy:**
- Endpoints p√∫blicos: IP address
- Endpoints autenticados: User ID (JWT claim)

**Headers de Resposta:**
```http
X-RateLimit-Remaining: 95
X-RateLimit-Reset: 1735987200000
Retry-After: 60  # quando bloqueado (HTTP 429)
```

#### 2. Autentica√ß√£o JWT (Stateless)

**Configura√ß√£o:**
- Algoritmo: HS512 (512-bit secret)
- Expira√ß√£o: 24 horas
- Claims: userId, email, role, iat, exp

**Fluxo:**
```
1. POST /api/v1/auth/login
   ‚Üí BCrypt password verification
2. Token generation (HS512)
3. Response: { token, type: "Bearer", user }
4. Requests: Authorization: Bearer {token}
5. JwtAuthenticationFilter validates token
```

**Prote√ß√µes Implementadas:**
- Senhas com BCrypt (cost factor 10)
- **Password Complexity Validation**: 12+ chars, uppercase, lowercase, numbers, special chars
- **Account Lockout**: 5 tentativas ‚Üí 30 min bloqueio (Caffeine cache)
- Secret rotation via config externa (n√£o hardcoded)

#### 3. Autoriza√ß√£o RBAC (Role-Based Access Control)

**Roles:**
- `ADMIN` - Full CRUD, relat√≥rios, monitoramento
- `USER` - Pedidos pr√≥prios, visualiza√ß√£o de produtos

**Implementa√ß√£o:**
```java
@PreAuthorize("hasRole('ADMIN')")
public ResponseEntity<?> adminEndpoint() { ... }

// Ownership validation
public OrderResponse getOrderByIdForUser(UUID orderId, User currentUser) {
    Order order = orderRepository.findByIdWithUser(orderId);
    if (!order.getUser().equals(currentUser)) {
        throw new BusinessException("Access denied", HttpStatus.FORBIDDEN);
    }
    return orderMapper.toResponse(order);
}
```

#### 4. Prote√ß√µes Adicionais

‚úÖ **SQL Injection**: JPA com prepared statements
‚úÖ **XSS**: JSON serialization sem HTML rendering
‚úÖ **CSRF**: N√£o aplic√°vel (API stateless)
‚úÖ **Sensitive Data**: Passwords com `@JsonIgnore`
‚úÖ **Idempotency Keys**: Previne pedidos duplicados (V3 migration)
‚úÖ **Stack Trace Sanitization**: Erros gen√©ricos em produ√ß√£o

---

## üõ°Ô∏è Resili√™ncia e Consist√™ncia

### Circuit Breaker Pattern (Resilience4j)

Previne **cascading failures** quando depend√™ncias externas falham.

#### Configura√ß√µes por Servi√ßo

**1. Elasticsearch (AGRESSIVO - tem fallback MySQL)**
```yaml
failure-rate-threshold: 50%       # 50% falhas ‚Üí OPEN
slow-call-duration-threshold: 3s
wait-duration-in-open-state: 30s
sliding-window-size: 10
```

**Fallback Strategy:**
```java
@CircuitBreaker(name = "elasticsearch", fallbackMethod = "searchFallback")
public List<ProductResponse> searchByName(String name) {
    return elasticsearchRepo.findByNomeWithFuzziness(name);
}

private List<ProductResponse> searchFallback(String name, Throwable t) {
    log.warn("‚ö†Ô∏è ES circuit OPEN, using MySQL fallback");
    return mysqlRepo.findByNomeContainingIgnoreCase(name);
}
```

**Trade-off**: Perde fuzzy matching, mas mant√©m disponibilidade.

**2. Kafka (MODERADO - eventos cr√≠ticos)**
```yaml
failure-rate-threshold: 60%
wait-duration-in-open-state: 60s
sliding-window-size: 20
```
- Aplicado em: `OutboxPublisher.publishEvent()`
- Prote√ß√£o: Evita thread pool exhaustion

**3. MySQL (CONSERVADOR - datasource prim√°rio)**
```yaml
failure-rate-threshold: 70%
slow-call-duration-threshold: 2s
record-exceptions:
  - DataAccessResourceFailureException
  - CannotGetJdbcConnectionException
  - SQLException
ignore-exceptions:
  - ResourceNotFoundException  # ‚Üí HTTP 404
  - BusinessException          # ‚Üí HTTP 400/403
```
- **CR√çTICO**: Apenas exce√ß√µes de infraestrutura trigam o breaker
- Exce√ß√µes de neg√≥cio passam para GlobalExceptionHandler

**Monitoramento:**
```bash
GET /api/v1/admin/circuit-breakers/status
```

---

### Transactional Outbox Pattern

**Problema:** Dual-write antipattern
```java
// ‚ùå PROBLEMA: Event loss on Kafka failure
@Transactional
public void payOrder(UUID orderId) {
    orderRepository.save(order);        // ‚úÖ MySQL commit
    kafkaTemplate.send("order.paid");   // ‚ùå Kafka down - EVENT LOST!
}
```

**Solu√ß√£o:** Outbox table com ACID guarantees

#### Arquitetura
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ @Transactional (ACID)                    ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ 1. UPDATE orders SET status='PAGO'  ‚îÇ ‚îÇ
‚îÇ ‚îÇ 2. INSERT INTO outbox_events (...)  ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ              ‚¨á COMMIT                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚¨á
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ OutboxPublisher (@Scheduled 5s)          ‚îÇ
‚îÇ 1. SELECT * FROM outbox_events           ‚îÇ
‚îÇ    WHERE published = false               ‚îÇ
‚îÇ 2. kafkaTemplate.send(event)             ‚îÇ
‚îÇ 3. UPDATE published = true               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Garantias:**
| Garantia | Descri√ß√£o |
|----------|-----------|
| **Atomicity** | Evento salvo na mesma TX (ACID) |
| **Durability** | Sobrevive a crashes |
| **At-Least-Once** | Retry infinito com backoff |
| **Idempotency** | Consumer verifica duplicatas |
| **Ordering** | Kafka partition key = aggregateId |

**Uso Correto:**
```java
@Transactional  // ‚¨ÖÔ∏è Necess√°rio para MANDATORY propagation
public PaymentResponse payOrder(UUID orderId, User user) {
    order.markAsPaid();
    orderRepository.save(order);

    // MESMA transa√ß√£o
    outboxService.saveEvent("ORDER", orderId.toString(), "ORDER_PAID",
                           orderEvent, AppConstants.TOPIC_ORDER_PAID);

    return new PaymentResponse("Pagamento confirmado");
}
```

---

### Dead Letter Queue (DLQ) + Automatic Reprocessing

**Problema:** Eventos falham quando Elasticsearch est√° offline

**Solu√ß√£o:** Consumer armazena eventos falhos em `failed_events` table e reprocessa automaticamente com **exponential backoff**.

**Fluxo:**
```
Kafka Event ‚Üí Consumer Fails (3 retries) ‚Üí DLQ Topic
                                              ‚Üì
                                    DeadLetterQueueConsumer
                                              ‚Üì
                                    failed_events table
                                              ‚Üì
                             FailedEventReprocessor (@Scheduled 2min)
                                              ‚Üì
                             Exponential Backoff:
                             1m ‚Üí 2m ‚Üí 4m ‚Üí 8m ‚Üí 16m ‚Üí 32m ‚Üí 60m
```

**Garantias:**
‚úÖ Eventos sobrevivem a restarts
‚úÖ Consist√™ncia eventual quando servi√ßos recuperam
‚úÖ Backpressure control (evita overload)
‚úÖ Circuit Breaker protection

Veja [case-ecommerce-consumer/README.md](../case-ecommerce-consumer/README.md) para detalhes.

---

## üìä Consist√™ncia de Dados

### Dual-Repository Pattern (MySQL + Elasticsearch)

**Reposit√≥rios separados** para evitar conflitos Spring Data:

- **JPA Repositories** (`repository.jpa.*`) - MySQL com ACID
- **Elasticsearch Repositories** (`repository.search.*`) - Full-text search

**Configura√ß√£o:**
```java
@EnableJpaRepositories(basePackages = "com.foursales.ecommerce.repository.jpa")
@EnableElasticsearchRepositories(basePackages = "com.foursales.ecommerce.repository.search")
```

**IMPORTANTE:** NUNCA misturar anota√ß√µes JPA e ES na mesma entidade.

### Product Sync via Event Sourcing

**Problema:** Produto criado no MySQL n√£o aparece no Elasticsearch

**Solu√ß√£o:** Event-driven sync com idempot√™ncia

**Fluxo:**
```
1. ProductService.createProduct()
   - Salva MySQL (@Transactional)
   - Publica ProductSyncEvent via Outbox
2. OutboxPublisher ‚Üí Kafka (topic: product.sync)
3. ProductSyncEventConsumer:
   - Verifica idempot√™ncia (processed_events table)
   - Se n√£o processado:
     a) Sincroniza com Elasticsearch
     b) Registra evento como processado
```

**Idempot√™ncia:**
```sql
CREATE TABLE processed_events (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    event_id VARCHAR(100) NOT NULL UNIQUE,  -- UUID
    event_type VARCHAR(50) NOT NULL,
    aggregate_id VARCHAR(100) NOT NULL,
    processed_at TIMESTAMP NOT NULL,
    status VARCHAR(20) NOT NULL,
    INDEX idx_event_id (event_id)
);
```

---

## üóÑÔ∏è Database Migrations (Flyway)

### Estrat√©gia

```yaml
spring:
  jpa:
    hibernate:
      ddl-auto: validate  # ‚ö†Ô∏è APENAS valida, N√ÉO modifica schema
  flyway:
    enabled: true
    baseline-on-migrate: true
    locations: classpath:db/migration
    validate-on-migrate: true
```

### Migrations Aplicadas

**V1__initial_schema.sql** - Schema base
- `users` - Autentica√ß√£o JWT, roles (ADMIN/USER)
- `products` - Cat√°logo com estoque
- `orders` - Pedidos com status (PENDENTE, PAGO, CANCELADO)
- `order_items` - Itens com quantidade e pre√ßo unit√°rio
- `outbox_events` - Transactional Outbox

**V2__add_performance_indexes.sql** - Performance
- 13 √≠ndices estrat√©gicos (10-100x speedup)
- `idx_outbox_published_created` - Outbox query optimization
- `idx_orders_user_id_status` - User orders query
- `idx_products_category` - Category filtering

**V3__add_idempotency_key.sql** - Idempot√™ncia
- `idempotency_key` column in orders
- UNIQUE constraint (user_id, idempotency_key)
- Previne pedidos duplicados (double-click, retry)

### Adicionar Nova Migration

```bash
# 1. Criar arquivo versionado
# src/main/resources/db/migration/V4__add_feature.sql

# 2. Escrever SQL DDL
ALTER TABLE users ADD COLUMN phone VARCHAR(20);
CREATE INDEX idx_users_phone ON users(phone);

# 3. Restart aplica√ß√£o (Flyway aplica automaticamente)
mvn spring-boot:run
```

**‚ö†Ô∏è NUNCA modificar migrations executadas** (checksum validation)

---

## üéØ Boas Pr√°ticas Implementadas

### SOLID Principles

**Dependency Inversion:**
```java
// Controllers dependem de INTERFACES
@RequiredArgsConstructor
public class OrderController {
    private final IOrderService orderService;  // ‚úÖ Interface
}
```

**Interfaces:**
- `IOrderService`, `IProductService`, `IReportService`, `IAuthService`
- Facilita testes (mocks), permite m√∫ltiplas implementa√ß√µes


**Pessimistic Locking** (Race Condition Fix):
```java
// Previne TOCTOU em stock operations
@Lock(PESSIMISTIC_WRITE)
@Query("SELECT p FROM Product p WHERE p.id = :id")
Optional<Product> findByIdForUpdate(@Param("id") UUID id);
```

**HikariCP Tuning:**
```yaml
hikari:
  minimum-idle: 10
  maximum-pool-size: 20
  connection-timeout: 30000
  leak-detection-threshold: 60000
  max-lifetime: 1800000
```

---

## üõ†Ô∏è Monitoramento

- **Swagger UI**: http://localhost:8080/swagger-ui.html
- **Circuit Breakers**: `GET /api/v1/admin/circuit-breakers/status`
- **Outbox Stats**: `GET /api/v1/admin/outbox/stats`
- **Rate Limit Stats**: `GET /api/v1/admin/rate-limit/stats`
- **Elasticsearch Indices**: http://localhost:9200/_cat/indices
- **Kafka UI**: http://localhost:8090

---

## üêõ Troubleshooting

### Circuit Breaker Always Open
```bash
# Verificar sa√∫de do servi√ßo
curl http://localhost:9200/_cluster/health

# For√ßar transi√ß√£o para CLOSED
curl -X POST http://localhost:8080/api/v1/admin/circuit-breakers/elasticsearch/transition?targetState=CLOSED \
  -H "Authorization: Bearer {admin-token}"
```

### Outbox Events Stuck
```bash
# Ver eventos presos
curl http://localhost:8080/api/v1/admin/outbox/stuck \
  -H "Authorization: Bearer {admin-token}"

# Retry manual
curl -X POST http://localhost:8080/api/v1/admin/outbox/retry/{id} \
  -H "Authorization: Bearer {admin-token}"
```

### Elasticsearch Date Format Error
```bash
curl -X DELETE "localhost:9200/products"
# Restart para recriar √≠ndice
```

---

## üìñ Documenta√ß√£o Adicional

- [CLAUDE.md](../CLAUDE.md) - Guia completo para IA assistants
- [RATE_LIMITING_GUIDE.md](./docs/RATE_LIMITING_GUIDE.md) - Detalhes de rate limiting
- [ADVANCED_TESTS_REPORT.md](./docs/ADVANCED_TESTS_REPORT.md) - Detalhes dos Testes avan√ßados
- [QA_TEST_REPORT.md](./docs/QA_TEST_REPORT.md) - Relatorio geral de testes executados

---

### Proposta de evolu√ß√£o
- Implementar mecanismos de tracing distribu√≠do. Sugest√£o √© delegar para camada de infraestrutura utilizando solu√ß√µes como OpenTelemetry, por exemplo.
- Implementar estrat√©gias de cache na consulta de produtos.
- Separar a consulta da escrita utilizando padr√£o como CQRS, por exemplo.
---

**Vers√£o**: 1.0.0
**√öltima Atualiza√ß√£o**: Outubro 2025
**Desenvolvido como desafio t√©cnico para Foursales**

### Destaques T√©cnicos

‚úÖ **Resili√™ncia**: Circuit Breaker, Retry, Fallbacks, DLQ
‚úÖ **Consist√™ncia**: Transactional Outbox, Event Sourcing, Idempotency
‚úÖ **Seguran√ßa**: Rate Limiting, JWT, RBAC, Account Lockout, Password Complexity
‚úÖ **Performance**: Pessimistic Locking, N+1 Fix, HikariCP, Indexes
‚úÖ **Observabilidade**: Logs, Metrics, Admin endpoints, Swagger UI
‚úÖ **Boas Pr√°ticas**: SOLID, Clean Code, Flyway Migrations

### Considera√ß√µes finais
Para desenvolvimento do projeto, foram utilizados recursos de IA para:
 - Acelerar o desenvolvimento
 - Auxilio na elabora√ß√£o da documenta√ß√£o
 - Execu√ß√£o, simula√ß√£o e gera√ß√£o dos relat√≥rios de testes
 - Explora√ß√£o de vulnerabilidades de seguran√ßa e sugest√µes de melhorias. (simulando ambiente real)

**Importante** O uso de IA ajuda a potencializar o desenvolvimento mas n√£o diminui a autoria.

